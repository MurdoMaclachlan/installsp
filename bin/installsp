#!/bin/bash

# This software is provided "as-is" and without warranty.
#
# It is licensed under the Creative Commons Attribution-ShareAlike 4.0 International license.
#
# If redistributing, credit Murdo B. Maclachlan and retain any credits to third-parties,
# such as exterior sources for code, listed within this program.
#
# For more information, see /usr/doc/installsp/LICENSE or creativecommons.org.

version=0.1.0

# Adapted from StackOverflow; credit to Oriettaxx and Rom√°rio. URL:
# https://stackoverflow.com/questions/8063228/check-if-a-variable-exists-in-a-list-in-bash/20473191#20473191
function list_contains {
    if [[ $1 =~ (^|[[:space:]])"$2"($|[[:space:]]) ]]; then
        return 0
    else
        return 1
    fi
}

list_contains "$@" "-h" && help=1 || list_contains "$@" "--help" && help=1
list_contains "$@" "-l" && license=1 || list_contains "$@" "--license" && license=1
list_contains "$@" "-v" && call_version=1 || list_contains "$@" "--version" && call_version=1

# Show help menu / license / version
if [[ $help ]]; then
    help_text=$(< /usr/doc/installsp/help.txt)
    IFS='%'
    echo -e "$help_text"
    exit 1
elif [[ $license ]]; then
    license_text=$(< /usr/doc/installsp/LICENSE_SHORT)
    IFS='%'
    echo -e "$license_text"
    exit 1
elif [[ $call_version ]]; then
    echo "installsp: Version: $version"
    exit 1
fi

# Import config options
# shellcheck source=/dev/null
source "/usr/share/installsp/config.sh"

# Read package name from args
if [[ $1 ]]; then
    spname=$1
else
    echo "installsp: No package specified, exiting. Run 'installsp --help' for details."
    exit 0
fi

# Read repository location from args or fall back to default from config
if [[ $2 ]]; then
    mvloc=$2
else
    mvloc=$repository
fi

# Move and install package
if [ -f "$sploc$sbname" ]; then 
    if [ -d "$mvloc" ]; then
        mv "$sploc$spname" "$mvloc$spname"
    else
        echo "installsp: Could not find directory '$mvloc', not moving package. Will still install."
    fi
    installpkg "$mvloc$spname"
    echo "installsp: Moved and installed package: $spname"
    exit 1
else
    echo "installsp: Could not find package at: $sploc$spname"
    exit 0
fi